<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Document System</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    h1 { margin:0; font-size: 20px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    input, select, button { padding: 10px 12px; border-radius: 10px; border:1px solid #ddd; }
    button { cursor:pointer; }
    .pill { padding: 6px 10px; border-radius: 999px; border:1px solid #ddd; background:#f7f7f7; }
    table { width:100%; border-collapse: collapse; margin-top: 14px; }
    th, td { text-align:left; padding: 10px; border-bottom:1px solid #eee; vertical-align: top; }
    th { background:#fafafa; position: sticky; top: 0; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .muted { color:#666; font-size: 12px; }
    .ok { color: #0a7; }
    .bad { color: #c33; }
    .right { margin-left:auto; }
    .card { border:1px solid #eee; border-radius: 14px; padding: 12px; margin-top: 14px; background:#fff; }
    code { background:#f5f5f5; padding:2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>üìÑ Document Management</h1>
    <span class="pill" id="modePill">‡πÇ‡∏´‡∏°‡∏î: ‡∏õ‡∏Å‡∏ï‡∏¥</span>
    <span class="right muted" id="statusText">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
  </header>

  <div class="card">
    <div class="row">
      <button id="btnNormal">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥</button>
      <button id="btnTrash">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</button>

      <input id="q" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå / mime / path)" style="min-width:280px;" />
      <button id="btnSearch">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>

      <span class="right muted">
        deleted_by (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß): <input id="deletedBy" value="1" style="width:80px;" />
      </span>
    </div>

    <div class="row muted">
      <div>API ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: <code>/api/documents</code> | <code>/api/documents/:id/download</code> | <code>DELETE /api/documents/:id</code> | <code>/api/documents/trash</code> | <code>PATCH /api/documents/:id/restore</code></div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:70px;">ID</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå</th>
          <th style="width:140px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th style="width:110px;">‡∏Ç‡∏ô‡∏≤‡∏î</th>
          <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏ü‡∏•‡πå</th>
          <th style="width:320px;">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
  const tbody = document.getElementById("tbody");
  const statusText = document.getElementById("statusText");
  const modePill = document.getElementById("modePill");
  const qInput = document.getElementById("q");
  const deletedByInput = document.getElementById("deletedBy");

  let mode = "normal"; // normal | trash

  function setStatus(text, kind="") {
    statusText.textContent = text;
    statusText.className = kind ? kind : "muted";
  }

  function fmtBytes(n) {
    if (n == null) return "-";
    const num = Number(n);
    if (Number.isNaN(num)) return String(n);
    const units = ["B","KB","MB","GB"];
    let v = num, i = 0;
    while (v >= 1024 && i < units.length-1) { v /= 1024; i++; }
    return `${v.toFixed(i===0?0:2)} ${units[i]}`;
  }

  function esc(s) {
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  async function api(path, opts) {
    const res = await fetch(path, {
      headers: { "Content-Type": "application/json" },
      ...opts,
    });
    const isJson = (res.headers.get("content-type") || "").includes("application/json");
    const data = isJson ? await res.json() : await res.text();
    if (!res.ok) {
      const msg = isJson ? (data?.error ? JSON.stringify(data.error) : "ERROR") : String(data);
      throw new Error(`${res.status} ${res.statusText} - ${msg}`);
    }
    return data;
  }

  function renderRows(rows) {
    tbody.innerHTML = "";
    if (!rows || rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
      return;
    }

    for (const d of rows) {
      const id = d.document_id;
      const name = d.original_file_name || "-";
      const mime = d.mime_type || "-";
      const size = fmtBytes(d.file_size);
      const p = d.file_path || "-";

      const downloadUrl = `/api/documents/${id}/download`;

      const actionHtml = mode === "normal"
        ? `
          <div class="actions">
            <a href="${downloadUrl}" target="_blank" rel="noopener">
              <button>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
            </a>
            <button data-del="${id}">‡∏•‡∏ö (soft)</button>
          </div>
          <div class="muted">created_by: ${esc(d.created_by ?? "-")} | created_at: ${esc(d.created_at ?? "-")}</div>
        `
        : `
          <div class="actions">
            <button data-restore="${id}">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
            <a href="${downloadUrl}" target="_blank" rel="noopener">
              <button>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
            </a>
          </div>
          <div class="muted">deleted_by: ${esc(d.deleted_by ?? "-")} | deleted_at: ${esc(d.deleted_at ?? "-")}</div>
        `;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(id)}</td>
        <td>${esc(name)}</td>
        <td>${esc(mime)}</td>
        <td>${esc(size)}</td>
        <td><span class="muted">${esc(p)}</span></td>
        <td>${actionHtml}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function load() {
    try {
      setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...", "muted");
      const q = qInput.value.trim();

      let url = mode === "trash" ? "/api/documents/trash" : "/api/documents";
      if (mode === "normal" && q) {
        url += `?q=${encodeURIComponent(q)}`;
      }

      const json = await api(url);
      renderRows(json.data);
      modePill.textContent = `‡πÇ‡∏´‡∏°‡∏î: ${mode === "trash" ? "‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞" : "‡∏õ‡∏Å‡∏ï‡∏¥"}`;
      setStatus("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "ok");
    } catch (e) {
      console.error(e);
      setStatus("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message, "bad");
    }
  }

  document.getElementById("btnNormal").addEventListener("click", () => {
    mode = "normal";
    load();
  });

  document.getElementById("btnTrash").addEventListener("click", () => {
    mode = "trash";
    load();
  });

  document.getElementById("btnSearch").addEventListener("click", () => {
    mode = "normal";
    load();
  });

  tbody.addEventListener("click", async (e) => {
    const delId = e.target?.getAttribute?.("data-del");
    const restoreId = e.target?.getAttribute?.("data-restore");

    try {
      if (delId) {
        const deleted_by = deletedByInput.value.trim() || "1";
        if (!confirm(`‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ID ${delId} ‡πÑ‡∏õ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞?`)) return;
        await api(`/api/documents/${delId}`, {
          method: "DELETE",
          body: JSON.stringify({ deleted_by }),
        });
        setStatus(`‡∏•‡∏ö ID ${delId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "ok");
        await load();
      }

      if (restoreId) {
        if (!confirm(`‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ID ${restoreId}?`)) return;
        await api(`/api/documents/${restoreId}/restore`, {
          method: "PATCH",
        });
        setStatus(`‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô ID ${restoreId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "ok");
        await load();
      }
    } catch (err) {
      console.error(err);
      setStatus("‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message, "bad");
    }
  });

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  load();
</script>
</body>
</html>
